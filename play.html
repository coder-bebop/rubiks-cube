<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
	<style>
		body {
			display: flex;
		}
		h1 {
			margin-bottom: 30px;
		}
		#menu {
			width: 20%;
			height: 100%;
			display: flex;
			flex-direction: column;
			align-items: center;
			padding: 20px;
		}
		#cube {
			width: 80%;
			height: 100%;
		}
		#timer {
			font-size: xx-large;
		}
		#moves 
		{
			flex-direction: row;
			margin-top: 30px;
		}
		#start {
			margin: 20px;
		}
		#stop {
			margin: 20px;
		}
		#restart {
			margin: 20px;
		}
		.move {
			margin: 3px;
			min-width: 45px;
		}
	</style>
	<title>Rubik's Cube</title>
</head>
<body>
	<div id="menu">
		<h1>Menu</h1>
		<div id="timer">
			<label id="minutes">00</label>:<label id="seconds">00</label>
		</div>
		<div>
			<button id="start" type="button" class="btn btn-primary btn-lg" onclick="startTimer()">Start</button>
			<button id="stop" type="button" class="btn btn-primary btn-lg" onclick="stopTimer()" disabled>Stop</button>
		</div>
		<div id="moves">
			<div>
				<button id="0" type="button" class="btn btn-outline-primary move" onclick="buttonMove(moves.U)">U</button>
				<button id="1" type="button" class="btn btn-outline-primary move" onclick="buttonMove(moves.UP)">U'</button>
				<button id="2" type="button" class="btn btn-outline-primary move" onclick="buttonMove(moves.D)">D</button>
				<button id="3" type="button" class="btn btn-outline-primary move" onclick="buttonMove(moves.DP)">D'</button>
			</div>
			<div>
				<button id="4" type="button" class="btn btn-outline-primary move" onclick="buttonMove(moves.R)">R</button>
				<button id="5" type="button" class="btn btn-outline-primary move" onclick="buttonMove(moves.RP)">R'</button>
				<button id="6" type="button" class="btn btn-outline-primary move" onclick="buttonMove(moves.L)">L</button>
				<button id="7" type="button" class="btn btn-outline-primary move" onclick="buttonMove(moves.LP)">L'</button>
			</div>
			<div>
				<button id="8" type="button" class="btn btn-outline-primary move" onclick="buttonMove(moves.F)">F</button>
				<button id="9" type="button" class="btn btn-outline-primary move" onclick="buttonMove(moves.FP)">F'</button>
				<button id="10" type="button" class="btn btn-outline-primary move" onclick="buttonMove(moves.B)">B</button>
				<button id="11" type="button" class="btn btn-outline-primary move" onclick="buttonMove(moves.BP)">B'</button>
			</div>
		</div>
		<button id="restart" type="button" class="btn btn-primary btn-lg" onclick="restart()" disabled>Restart</button>
	</div>
	<div id="cube">
	</div>

	<script type="module" src="./cube.js"></script>
	<script src="./matrix.js"></script>
	<script type="module">
		import { renderMove, sendData } from "./cube.js";

		const urlParams = new URLSearchParams(window.location.search);
		let sec = 0;
		let timer;
		let cube;
		let newCube = true;
		
		const d = parseInt(urlParams.get("d"));
		const f0 = "#" + urlParams.get("f0");
		const f1 = "#" + urlParams.get("f1");
		const f2 = "#" + urlParams.get("f2");
		const f3 = "#" + urlParams.get("f3");
		const f4 = "#" + urlParams.get("f4");
		const f5 = "#" + urlParams.get("f5");

		sendData(d, f0, f1, f2, f3, f4, f5);

		function pad(val) {
			return val > 9 ? val : "0" + val;
		}

		function startTimer() {
			enableButtons();
			document.getElementById("stop").disabled = false;
			document.getElementById("start").disabled = true;
			timer = setInterval(function(){
				document.getElementById("seconds").innerHTML=pad(++sec%60);
				document.getElementById("minutes").innerHTML=pad(parseInt(sec/60,10));
			}, 1000);

			if (newCube) {
				start();
				newCube = false;
			}
		}

		function start() {
			document.getElementById("restart").disabled = false;
			const d = parseInt(urlParams.get("d"));
			cube = setup(d);
			cube = createCube(d);
		}

		function stopTimer() {
			disableButtons();
			document.getElementById("stop").disabled = true;
			document.getElementById("start").disabled = false;
			clearInterval(timer);
		}

		async function stop() {
			stopTimer()
			let winStr = "The cube has been solved!\n\n"
			winStr += "Your move history:\n"
			winStr += getHistory();
			winStr += "\n\nPress OK to go back to the main page."
			await sleep(250);
			alert(winStr);
			location.href = "index.html";
		}

		function restart() {
			stopTimer();
			let history = [];
			newCube = true;
			sec = 0;
			document.getElementById("seconds").innerHTML=pad(++sec%60);
			document.getElementById("minutes").innerHTML=pad(parseInt(sec/60,10));
			startTimer();
		}

		function buttonMove(move) {
			doMove(cube, move);
			renderMove(move, 5);
			if(isSolved(cube)) {
				stop();
			}
		}

		function enableButtons() {
			let tmp;
			for(let i = 0; i < 12; i++) {
				tmp = document.getElementById(i);
				tmp.disabled = false;
			}
		}

		function disableButtons() {
			let tmp;
			for(let i = 0; i < 12; i++) {
				tmp = document.getElementById(i);
				tmp.disabled = true;
			}
		}

		function sleep(ms) {
			return new Promise(resolve => setTimeout(resolve, ms));
		}

		disableButtons();
		document.getElementById("restart").disabled = true;

		window.start = start;
		window.stop = stop;
		window.startTimer = startTimer;
		window.stopTimer = stopTimer;
		window.restart = restart;
		window.buttonMove = buttonMove;
	</script>
</body>
</html>
